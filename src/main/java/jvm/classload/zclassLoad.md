# 类加载

## 分类
### 静态加载
编译时加载相关的类,如果没有则报错,依赖性太强
### 动态加载
运行时加载需要的类,如果运行时不用该类,则不报错,降低了依赖性


## 类加载时机

创建对象时(new)

子类被加载时,其父类也会加载

调用类中的静态成员时

通过反射加载、创建对象

## 类加载过程


### 编译

### 运行

### 加载(Loading)
将字节码文件(可能是class文件,jar包,甚至网络)转化为二进制字节流加载到内存,
并根据二进制字节流数据为之创建一个java.lang.Class对象。

此过程由类加载器完成。


### 连接(Linking)
将类的二进制数据合并到JRE中

#### 验证(verification)
确保Class 文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。
类加载会有一个SecurityManager的类来进行一些安全验证。[可以new 一个对象 debug进入看看]
可以使用 -Xverify:none 参数来关闭大部分的类验证措施,缩短虚拟机类加载的时间。

主要包括：

文件格式验证(是否以魔数oxcafebabe开头)

元数据验证

字节码验证

符号引用验证

#### 准备(preparation)
JVM会在该阶段对静态变量,分配内存并默认初始化(对应数据类型的默认初始值,如0、OL、null、false 等)。
这些变量所使用的内存都将在方法区中进行分配。


#### 解析(resolution)
虚拟机将常量池内的符号引用替换为直接引用的过程。

### 初始化(Initialization)
Jvm负责对类进行初始化, 这里主要是针对静态成员。

此阶段是执行 < clinit >()方法的过程。

< clinit >() 方法是由编译器按语句在源文件中出现的顺序，
依次自动收集类中的所有静态变量的赋值动作和静态代码块中的语句,并进行合并。


虚拟机会保证一个类的< clinit >()方法在多线程环境中被正确地加锁、同步，
如果多个线程同时去初始化一个类，
那么只会有一个线程去执行这个类的<clinit>()方法，
其他线程都需要阻塞等待，直到活动线程执行<clinit>()方法完毕[debug源码]
synchronized 同步代码块保证


